{% extends "base.html" %}
{% block content %}

<div class="container text-center mt-5">

  <!-- ========== LOADING SECTION ========== -->
  <div id="loading" class="{% if status == 'ready' %}d-none{% endif %}">
    <div class="alert alert-info shadow-sm rounded-pill py-3">
      ğŸ§ Conversion still in progress... Please wait a few seconds.
    </div>

    <h2 class="mt-5 text-primary fw-bold">
      ğŸ¶ Your MP3 is being prepared...
    </h2>

    <div class="d-flex justify-content-center mt-4">
      <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
    </div>

    <p class="mt-4 text-muted">
      This may take a short moment depending on the video length.
    </p>
  </div>

  <!-- ========== PLAYER SECTION ========== -->
  <div id="player" class="{% if status != 'ready' %}d-none{% endif %}">
    <div class="alert alert-success shadow-sm rounded-pill py-3">
      âœ… Conversion complete! Your MP3 is ready.
    </div>

    <h2 class="text-success fw-bold mb-4">ğŸµ Listen or download your MP3</h2>

    <div class="card shadow-sm p-4 mx-auto" style="max-width: 500px;">
      <audio id="audioPlayer" controls class="w-100 mb-3">
        <source src="" type="audio/mpeg">
        Your browser does not support the audio element.
      </audio>

      <div class="d-flex justify-content-center gap-3">
        <a id="downloadBtn" class="btn btn-success" href="#" download>â¬‡ï¸ Download MP3</a>
        <a class="btn btn-secondary" href="{{ url_for('upload_api.upload') }}">â¬…ï¸ Back to Upload</a>
      </div>
    </div>
  </div>

  <!-- ========== ERROR / NO FILE SECTION ========== -->
  {% if not fid %}
  <div class="alert alert-warning shadow-sm rounded-pill py-3 mt-4">
    âš ï¸ No file selected or invalid request.
  </div>
  <a class="btn btn-primary mt-2" href="{{ url_for('upload_api.upload') }}">
    Go to Upload Page
  </a>
  {% endif %}

</div>

<!-- ==========================
     STATUS CHECK SCRIPT (JS)
=========================== -->
<script>
  const fid = "{{ fid|safe }}";
  console.log("ğŸ¬ Initial video_fid:", fid);

  const audioPlayer = document.getElementById("audioPlayer");
  const downloadBtn = document.getElementById("downloadBtn");
  const loadingSection = document.getElementById("loading");
  const playerSection = document.getElementById("player");

  if (!fid || fid === "None") {
    console.warn("âŒ No valid fid provided.");  
  } else {
    checkStatus();
  }

  async function fileExists(url) {
    try {
      const res = await fetch(url, { method: "HEAD" });
      return res.ok;
    } catch {
      return false;
    }
  }

  let attempts = 0;
  const maxAttempts = 30; // 30 * 3sec = 90 seconds max polling

  async function checkStatus() {
    attempts++;
    console.log(`ğŸ” Checking conversion status... Attempt #${attempts}`);

    try {
      const response = await fetch(`/download/api/status?fid=${fid}`);
      const data = await response.json();
      console.log("ğŸ“¡ Response from /api/status:", data);

      if (data.ready && data.mp3_fid) {
        const mp3Url = `/download/mp3/${data.mp3_fid}`;
        console.log("âœ… MP3 ready:", mp3Url);
        showPlayer(mp3Url);
        return;
      }

      const fallbackUrl = `/download/mp3/${fid}`;
      const exists = await fileExists(fallbackUrl);
      if (exists) {
        console.log("ğŸ§ Found MP3 via fallback:", fallbackUrl);
        showPlayer(fallbackUrl);
        return;
      }

      if (attempts < maxAttempts) {
        setTimeout(checkStatus, 3000);
      } else {
        showTimeoutMessage();
      }

    } catch (err) {
      console.error("âŒ Error during polling:", err);
      if (attempts < maxAttempts) {
        setTimeout(checkStatus, 3000);
      } else {
        showTimeoutMessage();
      }
    }
  }

  function showPlayer(url) {
    console.log("ğŸµ Showing player for:", url);
    if (audioPlayer) audioPlayer.src = url;
    if (downloadBtn) downloadBtn.href = url;
    if (loadingSection) loadingSection.classList.add("d-none");
    if (playerSection) playerSection.classList.remove("d-none");
  }

  function showTimeoutMessage() {
    console.warn("âš ï¸ Timeout reached, stopping polling.");
    loadingSection.innerHTML = `
      <div class="alert alert-warning shadow-sm rounded-pill py-3">
        âš ï¸ Itâ€™s taking longer than expected.<br>
        <button class="btn btn-sm btn-outline-primary mt-2" onclick="location.reload()">
          ğŸ”„ Refresh Page
        </button>
      </div>`;
  }

  checkStatus();
</script>

{% endblock %}
