{% extends "base.html" %}
{% block content %}
<div class="container text-center mt-5">

  <h2 class="text-primary fw-bold mb-4">üé∂ Your MP3 is being prepared...</h2>

  <!-- Loading Spinner -->
  <div id="loading" class="mt-5">
    <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status"></div>
    <p class="text-muted mt-3">Please wait while we process your file...</p>
  </div>

  <!-- Player (hidden at first) -->
  <div id="player" class="d-none mt-5">
    <h3 class="text-success mb-3">‚úÖ Your MP3 is ready!</h3>
    <audio id="audioPlayer" controls class="w-75 mb-4"></audio>
    <div>
      <a id="downloadBtn" class="btn btn-primary btn-lg me-3" download>‚¨áÔ∏è Download MP3</a>
      <a href="/" class="btn btn-outline-secondary btn-lg">üè† Back to Home</a>
    </div>
  </div>

</div>

<script>
  // Get file id from Jinja context
  const fid = "{{ fid|safe }}";
  console.log("File ID:", fid);

  const playerDiv = document.getElementById("player");
  const loadingDiv = document.getElementById("loading");
  const audioPlayer = document.getElementById("audioPlayer");
  const downloadBtn = document.getElementById("downloadBtn");

  if (fid && fid !== "None") {
    async function checkStatus() {
      try {
        const response = await fetch(`/api/status?fid=${fid}`);
        if (!response.ok) throw new Error("Status check failed");
        const data = await response.json();
        console.log("Status check:", data);

        if (data.ready) {
          // File ready: update the UI
          const fileUrl = `/download/${fid}`;
          audioPlayer.src = fileUrl;
          downloadBtn.href = fileUrl;

          loadingDiv.classList.add("d-none");
          playerDiv.classList.remove("d-none");
        } else {
          setTimeout(checkStatus, 3000);
        }
      } catch (error) {
        console.error("Polling error:", error);
        setTimeout(checkStatus, 3000);
      }
    }

    // Start polling
    checkStatus();
  } else {
    console.warn("No file ID found in template context!");
    loadingDiv.innerHTML = `<p class="text-danger">Invalid file ID. Please try again.</p>`;
  }
</script>
{% endblock %}
